<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ç®¡ç†ç¦®ç‰©é é¢</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 0;
            max-width: 600px;
            margin: auto;
            background: linear-gradient(to bottom right, #ffd89b 0%, #ffd89b 40%, #ff9a9e 100%);
        }

        label {
            font-weight: bold;
            display: block;
            margin-top: 0;
        }

        input,
        textarea,
        select {
            display: block;
            margin: 10px 0;
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }

        .step-button {
            width: 100%;
            padding: 12px 24px;
            margin: 11px;
            font-size: 20px;
            font-weight: bold;
            color: black;
            border: none;
            border-radius: 999px;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            cursor: pointer;
            transition: background 0.3s;
        }

        .step-button:disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
        }

        .disabled-label {
            background: #ccc !important;
            color: #666 !important;
            cursor: not-allowed !important;
            pointer-events: none;
        }

        .step-button:hover:not(:disabled) {
            background: linear-gradient(to right, #43e97b, #38f9d7);
        }

        .progress {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0 30px;
            gap: 6px;
            overflow-x: auto;
        }

        .step-indicator {
            flex: 0 0 auto;
            text-align: center;
            margin: 5px;
            position: relative;
        }

        .step-indicator::before {
            content: attr(data-step);
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            border-radius: 50%;
            background: #ccc;
            color: #fff;
            font-weight: bold;
            margin-bottom: 5px;
            transition: background 0.3s, transform 0.3s;
        }

        .step-indicator.done::before {
            content: "âœ“";
            background: #4facfe;
            transform: scale(1.2);
        }

        .step-indicator span {
            display: block;
            margin-top: 5px;
            font-size: 20px;
        }

        .arrow {
            font-size: 32px;
            color: #ccc;
            transition: color 0.3s;
        }

        .arrow.active {
            color: #00f2fe;
            animation: shake 0.5s infinite;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(2px);
            }

            50% {
                transform: translateX(-2px);
            }

            75% {
                transform: translateX(2px);
            }
        }

        /* éš±è—çœŸå¯¦æª”æ¡ˆ INPUT */
        #pdf,
        #pdfFile,
        #coverImage,
        #coverImageFile {
            display: none;
        }

        /* é¸æ“‡æª”æ¡ˆæŒ‰éˆ• */
        #fileLabel,
        #imageLabel {
            display: inline-block;
            padding: 12px 24px;
            margin: 15px;
            font-size: 22px;
            font-weight: bold;
            color: black;
            border: none;
            border-radius: 999px;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            cursor: pointer;
            transition: background 0.3s;
        }

        #fileLabel:hover:not(.disabled-label),
        #imageLabel:hover:not(.disabled-label) {
            background: linear-gradient(to right, #43e97b, #38f9d7);
        }

        #selectedFileName,
        #selectedImageName {
            margin-top: 5px;
            font-size: 20px;
            color: #333;
        }

        /* éƒ¨ç½²é€²åº¦æ¢ */
        #deployProgressContainer {
            display: none;
            width: 100%;
            background: #eee;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 20px;
            font-size: 24px;
            color: #333;
            padding: 10px;
        }

        #deployProgressContainer a {
            font-weight: bold;
            color: #0077cc;
            text-decoration: underline;
            font-size: 26px;
        }

        #deployProgressBarInner {
            width: 0;
            height: 20px;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            transition: width 0.3s;
        }

        .file-upload-section {
            margin: 20px 0;
            padding: 15px;
            border: 2px dashed #ccc;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body>
    <h1>ç®¡ç†ç¦®ç‰©é é¢</h1>

    <!-- é€²åº¦æ¢ -->
    <div class="progress" id="progressBar">
        <div class="step-indicator done" id="step0" data-step="0">
            <span>é–‹å§‹</span>
        </div>
        <div class="arrow active" id="arrow0">â¤</div>

        <div class="step-indicator" id="step1" data-step="1">
            <span>è¼‰å…¥è¨­å®š</span>
        </div>
        <div class="arrow" id="arrow1">â¤</div>

        <div class="step-indicator" id="step2" data-step="2">
            <span>é¸æ“‡æª”æ¡ˆ</span>
        </div>
        <div class="arrow" id="arrow2">â¤</div>

        <div class="step-indicator" id="step3" data-step="3">
            <span>ä¸Šå‚³æª”æ¡ˆ</span>
        </div>
        <div class="arrow" id="arrow3">â¤</div>

        <div class="step-indicator" id="step4" data-step="4">
            <span>æ›´æ–°ç¶²ç«™</span>
        </div>
    </div>

    <!-- æ¬„ä½ & æŒ‰éˆ• -->
    <label for="token">GitHub Token</label>
    <input type="password" id="token" placeholder="è¼¸å…¥ä½ çš„ GitHub Token" />
    <button id="loadButton" class="step-button" onclick="loadData()">
        1. è¼‰å…¥ç›®å‰è¨­å®š
    </button>

    <label for="pageTitle">ç¶²é é é¢åç¨±</label>
    <input id="pageTitle" />

    <label for="lang">é é¢èªè¨€</label>
    <select id="lang">
        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
        <option value="en">English</option>
        <option value="ja">æ—¥æœ¬èª</option>
    </select>

    <label for="title">ç¦®ç‰©é é¢æ¨™é¡Œ</label>
    <input id="title" />

    <label for="subtitle">é–‹å•Ÿç¦®ç‰©å¾Œå…§æ–‡</label>
    <input id="subtitle" />

    <input id="pdf" readonly />
    <input id="coverImage" readonly />

    <!-- å°é¢åœ–ç‰‡ä¸Šå‚³å€å¡Š -->
    <div class="file-upload-section">
        <h3>ğŸ“¸ å°é¢åœ–ç‰‡</h3>
        <label id="imageLabel" for="coverImageFile">
            2A. é¸æ“‡å°é¢åœ–ç‰‡
        </label>
        <input type="file" id="coverImageFile" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp" onchange="onImageSelected()" />
        <div id="selectedImageName"></div>
    </div>

    <!-- PDF ä¸Šå‚³å€å¡Š -->
    <div class="file-upload-section">
        <h3>ğŸ“„ PDF æª”æ¡ˆ</h3>
        <label id="fileLabel" for="pdfFile">
            2B. é¸æ“‡ PDF æª”æ¡ˆ
        </label>
        <input type="file" id="pdfFile" accept="application/pdf" onchange="onPDFSelected()" />
        <div id="selectedFileName"></div>
    </div>

    <button id="uploadButton" class="step-button" onclick="uploadFiles()">
        3. ä¸Šå‚³æª”æ¡ˆ
    </button>

    <!-- éƒ¨ç½²é€²åº¦æ¢ -->
    <div id="deployProgressContainer">
        <div id="deployProgressBarInner"></div>
    </div>

    <button id="updateButton" class="step-button" onclick="updateData()">
        4. æ›´æ–°ç¶²ç«™
    </button>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let owner = '';
        let repo = '';
        let sha = '';
        let isDeploying = false;
        let currentStep = 0;
        let filesSelected = { pdf: false, image: false };

        // åˆå§‹åŒ– repo è³‡è¨Š
        fetch(`data.json?bust=${Date.now()}`)
            .then(res => res.json())
            .then(data => {
                owner = data.owner;
                repo = data.repo;
            })
            .catch(err => alert('ç„¡æ³•è®€å– data.jsonï¼š' + err));

        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        function updateButtonStates() {
            document.getElementById('loadButton').disabled = currentStep !== 0;

            const fileLabel = document.getElementById('fileLabel');
            const imageLabel = document.getElementById('imageLabel');
            const uploadBtn = document.getElementById('uploadButton');
            const updateBtn = document.getElementById('updateButton');

            // æ­¥é©Ÿ1~2ï¼šé¸æ“‡æª”æ¡ˆå¯ç”¨
            if (currentStep >= 1 && currentStep < 3) {
                fileLabel.classList.remove('disabled-label');
                imageLabel.classList.remove('disabled-label');
            } else {
                fileLabel.classList.add('disabled-label');
                imageLabel.classList.add('disabled-label');
            }

            // æ­¥é©Ÿ2ï¼šä¸Šå‚³æª”æ¡ˆå¯ç”¨ï¼ˆéœ€è¦è‡³å°‘é¸æ“‡ä¸€å€‹æª”æ¡ˆï¼‰
            uploadBtn.disabled = (currentStep !== 2 || (!filesSelected.pdf && !filesSelected.image));

            // æ­¥é©Ÿ3ï¼šæ›´æ–°ç¶²ç«™å¯ç”¨
            updateBtn.disabled = (currentStep !== 3);
        }

        // æ¨™è¨˜å®Œæˆçš„æ­¥é©Ÿ
        function markStepDone(stepNumber) {
            document.getElementById('step' + stepNumber).classList.add('done');
            for (let i = 0; i < 4; i++) {
                const arrow = document.getElementById('arrow' + i);
                if (i < stepNumber) {
                    arrow.classList.add('active');
                    arrow.style.animation = 'none';
                } else if (i === stepNumber) {
                    arrow.classList.add('active');
                    arrow.style.animation = 'shake 0.5s infinite';
                } else {
                    arrow.classList.remove('active');
                    arrow.style.animation = 'none';
                }
            }
        }

        // DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            markStepDone(0);
            updateButtonStates();
        });

        // å–å¾— Token
        function getToken() {
            const token = document.getElementById('token').value.trim();
            if (!token) {
                alert('è«‹è¼¸å…¥ GitHub Token');
                throw new Error('Token is required');
            }
            return token;
        }

        // è¼‰å…¥ç›®å‰è¨­å®š
        function loadData() {
            const token = getToken();
            fetch(`https://api.github.com/repos/${owner}/${repo}/contents/data.json`, {
                headers: { Authorization: `token ${token}` }
            })
                .then(res => res.ok ? res.json() : Promise.reject('è®€å–å¤±æ•—'))
                .then(data => {
                    sha = data.sha;
                    const raw = atob(data.content);
                    const content = JSON.parse(decodeURIComponent(escape(raw)));
                    document.getElementById('pageTitle').value = content.pageTitle || '';
                    document.getElementById('lang').value = content.lang || 'zh-TW';
                    document.getElementById('title').value = content.title || '';
                    document.getElementById('subtitle').value = content.subtitle || '';
                    document.getElementById('pdf').value = content.pdf || '';
                    document.getElementById('coverImage').value = content.coverImage || '';

                    currentStep = 1;
                    markStepDone(1);
                    updateButtonStates();
                })
                .catch(err => alert('è¼‰å…¥å¤±æ•—ï¼š' + err));
        }

        // é¸æ“‡å°é¢åœ–ç‰‡
        function onImageSelected() {
            const file = document.getElementById('coverImageFile').files[0];
            if (!file) return;
            document.getElementById('selectedImageName').textContent = 'å·²é¸æ“‡åœ–ç‰‡ï¼š' + file.name;
            filesSelected.image = true;

            if (currentStep < 2) {
                currentStep = 2;
                markStepDone(2);
            }
            updateButtonStates();
        }

        // é¸æ“‡ PDF æª”æ¡ˆ
        function onPDFSelected() {
            const file = document.getElementById('pdfFile').files[0];
            if (!file) return;
            document.getElementById('selectedFileName').textContent = 'å·²é¸æ“‡æª”æ¡ˆï¼š' + file.name;
            filesSelected.pdf = true;

            if (currentStep < 2) {
                currentStep = 2;
                markStepDone(2);
            }
            updateButtonStates();
        }

        // ä¸Šå‚³æª”æ¡ˆ
        function uploadFiles() {
            const token = getToken();
            const pdfFile = document.getElementById('pdfFile').files[0];
            const imageFile = document.getElementById('coverImageFile').files[0];

            if (!pdfFile && !imageFile) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æª”æ¡ˆ');
                return;
            }

            // ä¸Šå‚³é–‹å§‹æ™‚æç¤ºä¸¦æš«æ™‚ç¦ç”¨ä¸‹ä¸€æ­¥
            alert('æª”æ¡ˆä¸Šå‚³ä¸­ï¼Œè«‹ç¨ç­‰');
            document.getElementById('uploadButton').disabled = true;
            document.getElementById('updateButton').disabled = true;

            const uploadPromises = [];

            // ä¸Šå‚³ PDF
            if (pdfFile) {
                const pdfPromise = uploadFile(pdfFile, `pdfs/${pdfFile.name}`, token)
                    .then(() => {
                        document.getElementById('pdf').value = `pdfs/${pdfFile.name}`;
                    });
                uploadPromises.push(pdfPromise);
            }

            // ä¸Šå‚³åœ–ç‰‡
            if (imageFile) {
                const imagePromise = uploadFile(imageFile, `images/${imageFile.name}`, token)
                    .then(() => {
                        document.getElementById('coverImage').value = `images/${imageFile.name}`;
                    });
                uploadPromises.push(imagePromise);
            }

            Promise.all(uploadPromises)
                .then(() => {
                    currentStep = 3;
                    markStepDone(3);
                    alert('æª”æ¡ˆä¸Šå‚³å®Œç•¢ï¼Œå¯ä»¥æ›´æ–°ç¶²ç«™äº†');
                    updateButtonStates();
                })
                .catch(err => {
                    alert('ä¸Šå‚³å¤±æ•—ï¼š' + err);
                    currentStep = 2;
                    updateButtonStates();
                });
        }

        // ä¸Šå‚³å–®å€‹æª”æ¡ˆ
        function uploadFile(file, path, token) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    
                    fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                        method: 'PUT',
                        headers: { Authorization: `token ${token}` },
                        body: JSON.stringify({ message: `Upload ${file.name}`, content: base64 })
                    })
                        .then(res => res.ok ? res.json() : Promise.reject('ä¸Šå‚³å¤±æ•—'))
                        .then(() => resolve())
                        .catch(err => reject(err));
                };
                reader.readAsDataURL(file);
            });
        }

        // æ›´æ–°ç¶²ç«™
        function updateData() {
            if (isDeploying) {
                alert('éƒ¨ç½²ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                return;
            }
            isDeploying = true;
            const token = getToken();
            const payload = {
                pageTitle: document.getElementById('pageTitle').value,
                lang: document.getElementById('lang').value,
                title: document.getElementById('title').value,
                subtitle: document.getElementById('subtitle').value,
                pdf: document.getElementById('pdf').value,
                coverImage: document.getElementById('coverImage').value,
                owner,
                repo
            };

            fetch(`https://api.github.com/repos/${owner}/${repo}/contents/data.json`, {
                method: 'PUT',
                headers: { Authorization: `token ${token}` },
                body: JSON.stringify({
                    message: 'Update data.json',
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(payload, null, 2)))),
                    sha
                })
            })
                .then(res => res.ok ? res.json() : Promise.reject('æ›´æ–°å¤±æ•—'))
                .then(() => {
                    currentStep = 4;
                    markStepDone(4);
                    updateButtonStates();
                    alert('è³‡æ–™æ›´æ–°æˆåŠŸï¼Œé–‹å§‹éƒ¨ç½²...');
                    triggerWorkflow(token);
                })
                .catch(err => {
                    alert('æ›´æ–°å¤±æ•—ï¼š' + err);
                    isDeploying = false;
                });
        }

        // è§¸ç™¼ CI/CD éƒ¨ç½²
        async function triggerWorkflow(token) {
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${owner}/${repo}/actions/workflows/deploy.yml/dispatches`,
                    {
                        method: 'POST',
                        headers: { Authorization: `token ${token}`, Accept: 'application/vnd.github+json' },
                        body: JSON.stringify({ ref: 'main' })
                    }
                );

                if (!response.ok) throw new Error('éƒ¨ç½²è§¸ç™¼å¤±æ•—');
                alert('éƒ¨ç½²å·²æˆåŠŸè§¸ç™¼ï¼Œ5 ç§’å¾Œé¡¯ç¤ºé€²åº¦æ¢ä¸¦é–‹å§‹ç›£æ§é€²åº¦...');
                waitForWorkflow(token);

            } catch (error) {
                alert('éƒ¨ç½²éŒ¯èª¤ï¼š' + error.message);
                isDeploying = false;
            }
        }

        // ç­‰å¾… Workflow åŸ·è¡Œ
        function waitForWorkflow(token) {
            const container = document.getElementById('deployProgressContainer');
            const bar = document.getElementById('deployProgressBarInner');

            setTimeout(() => {
                container.style.display = 'block';
                bar.style.width = '0';

                fetch(
                    `https://api.github.com/repos/${owner}/${repo}/actions/workflows/deploy.yml/runs?branch=main&per_page=1`,
                    { headers: { Authorization: `token ${token}` } }
                )
                    .then(res => res.json())
                    .then(json => {
                        const runId = json.workflow_runs[0]?.id;
                        if (!runId) throw new Error('æ‰¾ä¸åˆ° workflow run');
                        pollRunStatus(runId, token, container, bar);
                    })
                    .catch(err => alert('ç„¡æ³•å–å¾— workflow runï¼š' + err.message));

            }, 5000);
        }

        // ç›£æ§éƒ¨ç½²é€²åº¦
        function pollRunStatus(runId, token, container, bar) {
            let progress = 0;
            const interval = setInterval(() => {
                progress = (progress + 10) % 80 + 10;
                bar.style.width = progress + '%';

                fetch(
                    `https://api.github.com/repos/${owner}/${repo}/actions/runs/${runId}`,
                    { headers: { Authorization: `token ${token}` } }
                )
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'completed') {
                            clearInterval(interval);
                            bar.style.width = '100%';
                            // é¡¯ç¤ºå®Œæˆé€£çµï¼Œæ›¿æ›é€²åº¦æ¢å…§å®¹
                            const linkUrl = `https://${owner}.github.io/${repo}/`;
                            window.open(linkUrl, '_blank');
                            container.innerHTML = `éƒ¨ç½²å®Œæˆï¼<br>é»å³å´é€£çµé–‹å•Ÿä½ æ›´æ–°çš„ç¶²ç«™ï¼š <a href="${linkUrl}" target="_blank">${document.getElementById('pageTitle').value}</a>`;
                            // å¯é¡å¤–ä¿ç•™é€²åº¦æ¢é¡è‰²
                            container.style.display = 'block';
                            isDeploying = false;
                        }
                    })
                    .catch(console.error);

            }, 4000);
        }
    </script>
</body>

</html>
